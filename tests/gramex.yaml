variables:
  MYSQL_SERVER: {default: localhost}
  POSTGRES_SERVER: {default: localhost}

app:
  listen:
    port: 9999              # Avoid clash with default Gramex port running tests
  settings:
    xsrf_cookies: false     # Temporarily disable for testing

cache:
    memory:
        type: memory
    memory-20:
        type: memory
        size: 20
    disk:
        type: disk
        path: $YAMLPATH/.cache-url
    # We could test more disk caches, but they're slow

url:
  invalid-handler:
    pattern: /invalid-handler
    handler: NonExistent
  invalid-function:
    pattern: /invalid-function
    handler: FunctionHandler
    kwargs:
        function: nonexistent

  # TestGramex
  pathdepth1: {pattern: "/path/.*",       handler: "gramex.handlers.FunctionHandler", kwargs: {function: "str", args: ["/path/.*"],       }}
  pathdepth2: {pattern: "/path/file",     handler: FunctionHandler, kwargs: {function: str, args: ["/path/file"],     }}
  pathdepth3: {pattern: "/path/dir/.*",   handler: FunctionHandler, kwargs: {function: str, args: ["/path/dir/.*"],   }}
  pathdepth4: {pattern: "/path/dir/file", handler: FunctionHandler, kwargs: {function: str, args: ["/path/dir/file"], }}
  pathdepth5: {pattern: "/path/priority", priority: 1, handler: "FunctionHandler", kwargs: {function: "str", args: ["/path/priority"], }}

  pathnorm1: {pattern: "/./path/norm1", handler: FunctionHandler, kwargs: {function: str, args: ["/path/norm1"],    }}
  pathnorm2: {pattern: "/path/./norm2", handler: FunctionHandler, kwargs: {function: str, args: ["/path/norm2"],    }}

  # TestFunctionHandler
  func/args:
    pattern: /func/args
    handler: FunctionHandler
    kwargs:
      function: utils.params_as_json
      args: [0, 1]
      kwargs:
        a: "a"
        b: "b"

  func/async/args:
    pattern: /func/async/args
    handler: FunctionHandler
    kwargs:
      function: utils.async_args
      args: [0, 1]
      kwargs:
        a: "a"
        b: "b"

  func/handler:
    pattern: /func/handler
    handler: FunctionHandler
    kwargs:
      function: utils.params_as_json

  func/attributes:
    pattern: /func/attributes
    handler: FunctionHandler
    kwargs:
        function: utils.attributes

  func/composite:
    pattern: /func/composite
    handler: FunctionHandler
    kwargs:
      function: utils.params_as_json
      args: [0, =handler]
      kwargs:
        a: a
        handler: =handler

  func/compositenested:
    pattern: /func/compositenested
    handler: FunctionHandler
    kwargs:
      function: utils.params_as_json
      args: [0, =handler]
      kwargs:
        a:
          b: 1
        handler: =handler

  func/dumpx:
    pattern: /func/dumpx
    handler: FunctionHandler
    kwargs:
      function: utils.params_as_json
      args: =handler.get_arguments('x')

  func/async/http:
    pattern: /func/async/http
    handler: FunctionHandler
    kwargs:
      function: utils.async_http
      args: "http://localhost:9999/func/dumpx?x=1&x=2"

  func/async/http2:
    pattern: /func/async/http2
    handler: FunctionHandler
    kwargs:
      function: utils.async_http2
      args:
        - "http://localhost:9999/func/dumpx?x=1"
        - "http://localhost:9999/func/dumpx?x=2"

  func/async/calc:
    pattern: /func/async/calc
    handler: FunctionHandler
    kwargs:
      function: utils.async_calc

  func/iterator:
    pattern: /func/iterator
    handler: FunctionHandler
    kwargs:
      function: utils.iterator

  func/iterator/async:
    pattern: /func/iterator/async
    handler: FunctionHandler
    kwargs:
      function: utils.iterator_async

  # TestFileHandler
  dir/noindex:
    pattern: /dir/noindex/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      index: false
  dir/index:
    pattern: /dir/index/(.*)
    handler: FileHandler
    kwargs:
      # Adding a slash at the end of "dir/" should not disrupt anything
      path: dir/
      index: true
  dir/default-present-index:
    pattern: /dir/default-present-index/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      default_filename: index.html
      index: true
  dir/default-missing-index:
    pattern: /dir/default-missing-index/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      default_filename: nonexistent-file
      index: true
  dir/default-present-noindex:
    pattern: /dir/default-present-noindex/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      default_filename: index.html
      index: false
  dir/default-missing-noindex:
    pattern: /dir/default-missing-noindex/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      default_filename: nonexistent-file
      index: false
  dir/indextemplate:
    pattern: /dir/indextemplate/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      index: true
      index_template: index.template.html
  dir/no-indextemplate:
    pattern: /dir/no-indextemplate/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      index: true
      index_template: nonexistent.template.html
  dir/nonexistent-file:
    pattern: /dir/nonexistent-file
    handler: FileHandler
    kwargs:
      path: nonexistent-file
  dir/single-file:
    pattern: /dir/single-file/(.*)
    handler: FileHandler
    kwargs:
      path: dir/text.txt
  dir/normalize/slash:
    pattern: /dir/normalize/slash/(.*)/
    handler: FileHandler
    kwargs:
      path: dir
  dir/normalize/dot:
    pattern: /./dir/./normalize/./dot/./(.*)
    handler: FileHandler
    kwargs:
      path: dir
  dir/normalize/dotdot:
    pattern: /abc/../dir/normalize/abc/../dotdot/(.*)
    handler: FileHandler
    kwargs:
      path: dir
  dir/transform:
    pattern: /dir/transform/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      transform:
        "*.md":
          encoding: utf-8
          function: markdown.markdown
          args: =content
          headers:
            Content-Type: text/html; charset=UTF-8
        "*.yaml":
          encoding: utf-8
          function: badgerfish
          args: [=content, =handler]
          headers:
            Content-Type: text/html; charset=UTF-8
        "template.*":
          encoding: utf-8
          function: template
          args: =content
          kwargs:
            handler: =handler
            param: x
          headers:
            Content-Type: text/html; charset=UTF-8
        "template-handler.txt":
            encoding: utf-8
            function: template
  dir/args:
    pattern: /dir/args/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      default_filename: index.html
      transform:
        'index.html':
          function: utils.args_as_json
          args: =handler
  dir/merge.txt:
    pattern: /dir/merge.txt
    handler: FileHandler
    kwargs:
      path:
        - dir/alpha.txt
        - dir/beta.html
      transform:
        'alpha.txt':
          encoding: utf-8
          function: six.text_type.upper
          args: =content
        'beta.html':
          encoding: utf-8
          function: six.text_type.title
          args: =content
  dir/merge.html:
    pattern: /dir/merge.html
    handler: FileHandler
    kwargs:
      path:
        - dir/beta.html
        - dir/alpha.txt
      transform:
        'beta.html':
          encoding: utf-8
          function: six.text_type.upper
          args: =content
        'alpha.txt':
          encoding: utf-8
          function: six.text_type.title
          args: =content

  dir/data:
    pattern: /dir/data                # Check that a pattern without brackets works
    handler: FileHandler
    kwargs:
      path: dir/data.csv
      headers:
        Content-Type: text/plain      # Test header overriding
        Content-Disposition: null     # Test header clearing

  dir/pattern-text:
    pattern: "/dir/pattern/(.*)/text"
    handler: FileHandler
    kwargs:
      path: "dir/*.txt"

  dir/pattern-html:
    pattern: "/dir/pattern/(.*)\\.web"
    handler: FileHandler
    kwargs:
      path: "dir/*.html"

  dir/pattern-subdir:
    pattern: "/dir/pattern/(.*)/sub"
    handler: FileHandler
    kwargs:
      path: "dir/*/text.txt"

  dir/ignore-file:
    pattern: "/dir/ignore-file/(.*)"
    handler: FileHandler
    kwargs:
      path: dir/
      ignore: ignore-file.txt

  dir/ignore-list:
    pattern: "/dir/ignore-list/(.*)"
    handler: FileHandler
    kwargs:
      path: dir/
      ignore:
        - ignore-list.txt

  # Allow overrides global handler ignores
  dir/allow-file:
    pattern: "/dir/allow-file/(.*)"
    handler: FileHandler
    kwargs:
      path: dir/
      allow: gramex.yaml

  # Allow overrides local ignores
  dir/allow-ignore:
    pattern: "/dir/allow-ignore/(.*)"
    handler: FileHandler
    kwargs:
      path: dir/
      ignore: ignore-file.txt
      allow: ignore-file.txt

  # TestDataHandler for Sqlite
  data/csv:
    pattern: /datastore/sqlite/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      default: {format: csv}
  data/json:
    pattern: /datastore/sqlite/json/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      default: {format: json}
  data/html:
    pattern: /datastore/sqlite/html/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      default: {format: html}

  # Test datahandler for MySQL
  data/mysql/csv:
    pattern: /datastore/mysql/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: mysql+pymysql://root@$MYSQL_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8, connect_args: {charset: utf8}}
      default: {format: csv}
  data/mysql/json:
    pattern: /datastore/mysql/json/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: mysql+pymysql://root@$MYSQL_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8, connect_args: {charset: utf8}}
      default: {format: json}
  data/mysql/html:
    pattern: /datastore/mysql/html/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: mysql+pymysql://root@$MYSQL_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8, connect_args: {charset: utf8}}
      default: {format: html}

  # Test datahandler for PostgreSQL
  data/postgresql/csv:
    pattern: /datastore/postgresql/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: postgresql://postgres@$POSTGRES_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8}
      default: {format: csv}
  data/postgresql/json:
    pattern: /datastore/postgresql/json/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: postgresql://postgres@$POSTGRES_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8}
      default: {format: json}
  data/postgresql/html:
    pattern: /datastore/postgresql/html/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: postgresql://postgres@$POSTGRES_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8}
      default: {format: html}

  # TestDataHandler for blaze sqlite
  data/blaze/csv:
    pattern: /datastore/blazesqlite/csv/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      default: {format: csv}
  data/blaze/json:
    pattern: /datastore/blazesqlite/json/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      default: {format: json}
  data/blaze/html:
    pattern: /datastore/blazesqlite/html/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      default: {format: html}

  # Test datahandler for blaze MySQL
  data/blazemysql/csv:
    pattern: /datastore/blazemysql/csv/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: mysql+pymysql://root@$MYSQL_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8}
      default: {format: csv}
  data/blazemysql/json:
    pattern: /datastore/blazemysql/json/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: mysql+pymysql://root@$MYSQL_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8}
      default: {format: json}
  data/blazemysql/html:
    pattern: /datastore/blazemysql/html/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: mysql+pymysql://root@$MYSQL_SERVER/test_datahandler
      table: actors
      parameters: {encoding: utf8}
      default: {format: html}

  # TestDataHandlerConfig for Sqlite
  data/sqliteconfig1/csv:
    pattern: /datastore/sqliteconfig1/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      default:
        format: csv
        where: [votes<120]
  data/sqliteconfig2/csv:
    pattern: /datastore/sqliteconfig2/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      default:
        format: csv
        where: votes<120
  data/sqliteconfig3/csv:
    pattern: /datastore/sqliteconfig3/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      default:
        format: csv
      query:
        where: votes<120
  data/sqliteconfig4/csv:
    pattern: /datastore/sqliteconfig4/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      default:
        format: csv
        select: ["rating", "votes"]
      query:
        where: votes<120
  data/sqliteconfig5/csv:
    pattern: /datastore/sqliteconfig5/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      default:
        format: csv
        select:
          rating: "any-value"
          votes:
      query:
        where: votes<120
  data/sqliteconfig6/csv:
    pattern: /datastore/sqliteconfig6/csv/
    handler: DataHandler
    kwargs:
      driver: blaze
      url: sqlite:///actors.db
      table: actors
      default:
        format: csv
        select: ["category", "votenu"]
        groupby: "category"
      query:
        agg:
          ratemean: mean(rating)
          votenu: nunique(votes)
        where:
          votes: "<120"
          rating: ">0.4"
  data/sqliteconfig7/csv:
    pattern: /datastore/sqliteconfig7/csv/
    handler: DataHandler
    kwargs:
      driver: sqlalchemy
      url: sqlite:///actors.db
      table: actors
      parameters: {encoding: utf8}
      query:
        format: csv
        where: [votes<120]
        limit: 5

  watcher:
    pattern: /watcher
    handler: FileHandler
    kwargs:
      path: watcher.txt

  process/args:
    pattern: /process/args
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
  process/args-pipe:
    pattern: /process/args-pipe
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      stdout: pipe
      stderr: pipe
  process/args-no-stderr:
    pattern: /process/args-no-stderr
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      stderr: false
  process/args-no-stdout:
    pattern: /process/args-no-stdout
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      stdout: false
  process/args-stdout-file:
    pattern: /process/args-stdout-file
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      stdout: $YAMLPATH/processtest.stdout
  process/args-both-file:
    pattern: /process/args-both-file
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      stdout: $YAMLPATH/processtest.both
      stderr: $YAMLPATH/processtest.both
  process/args-multi-file:
    pattern: /process/args-multi-file
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      stdout: [$YAMLPATH/processtest.stdout.1, $YAMLPATH/processtest.stdout.2, pipe]
      stderr: [$YAMLPATH/processtest.stderr.1, $YAMLPATH/processtest.stderr.2, pipe]
  process/shell:
    pattern: /process/shell
    handler: ProcessHandler
    kwargs:
      args: 'python $YAMLPATH/processtest.py a 1 "x y"'
      shell: True
  process/cwd:
    pattern: /process/cwd
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/processtest.py", a, '1', 'x y']
      cwd: "${YAMLPATH}/../"
  process/nonexistent-command:
    pattern: /process/nonexistent-command
    handler: ProcessHandler
    kwargs:
      args: nonexistent-command
  process/error:
    pattern: /process/error
    handler: ProcessHandler
    kwargs:
      args: [python, "$YAMLPATH/throwerror.py"]

  httpbin:
    pattern: /httpbin
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
  cache/randomchar-nocache:
    pattern: /cache/randomchar-nocache
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999}
  cache/randomchar:
    pattern: /cache/randomchar
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999, mime: html}
    cache: true
  cache/pathkey:
    pattern: /cache/pathkey
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999, mime: json}
    cache:
      key: request.path
  cache/host:
    pattern: /cache/host.*
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999}
    cache:
      key: request.host
  cache/args:
    pattern: /cache/args.*
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999}
    cache:
      key: [request.path, args.x, invalid.key]
  cache/cookie-test:
    pattern: /cache/cookie-test
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999}
    cache:
      key: [request.host, cookies.user, invalid.key]
  cache/header-test:
    pattern: /cache/header-test
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999}
    cache:
      key: [request.host, headers.test, invalid.key]
  cache/invalid-keys-ignored:
    pattern: /cache/invalid-keys-ignored.*
    handler: FunctionHandler
    kwargs:
      function: utils.httpbin
      kwargs: {rand: 99999999}
    cache:
      key: [invalid, invalid.invalid]
  cache/filehandler:
    pattern: /cache/filehandler/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      allow: .cache-file*
    cache: true
  cache/filehandler-errors:
    pattern: /cache/filehandler-error/(.*)
    handler: FileHandler
    kwargs:
      path: dir
      allow: .cache-file*
    cache:
        status: [200, 404]

  json/get:
    pattern: /json/get/(.*)
    handler: JSONHandler
    kwargs:
        data:
            x: "1"
            y: {z: 2}
            z: [a, b, {m: 1, n: 2}]
  json/write:
    pattern: /json/write/(.*)
    handler: JSONHandler
  json/path:
    pattern: /json/path/(.*)
    handler: JSONHandler
    kwargs:
      path: $YAMLPATH/.jsonpath/jsonhandler.json

  api/twitter:
    pattern: /api/twitter/(.*)
    handler: TwitterRESTHandler
    kwargs:
      # Gramener > Gramex Test app: https://apps.twitter.com/app/12449610/keys
      consumer_key: XkCVNZD5sfWECxHGAGnlHGQFa
      consumer_secret: yU00bx5dHYMbge9IyO5H1KeC5uFnWndntG7u6CH6O4HDZHQg0p
      access_token: 445767176-jDMwN0oRYvEdTDTVLS6FSXufbP7pOQrgmnyKGjt4
      access_token_secret: hXrfLh1l2ClDh0RhXJd8lIpwQxQFtEjJpduKV2DyAyRVY

  auth/session:
    pattern: /auth/session
    handler: FunctionHandler
    kwargs:
        function: utils.session
        headers:
            Content-Type: application/json

  auth/ldap:
    pattern: /auth/ldap
    handler: LDAPAuth
    kwargs:
        template: $YAMLPATH/auth.html       # This has the login form
        host: ipa.demo1.freeipa.org         # Server to connect to
        use_ssl: true                       # Whether to use SSL or not
        user: 'uid={user},cn=users,cn=accounts,dc=demo1,dc=freeipa,dc=org'
        password: '{password}'

  auth/db:
    pattern: /auth/db
    handler: DBAuth
    kwargs:
        template: $YAMLPATH/auth.html
        # This is created by schedule.create-user-database
        url: 'mysql+pymysql://root@${MYSQL_SERVER}/test_auth'
        table: users
        user:
            column: user
            arg: user
        password:
            column: password
            arg: password
            function: six.text_type.__add__
            args: [=content, '123']
        redirect:
            query: next
            header: NEXT
            url: /dir/index/

  xsrf:
    pattern: /xsrf
    handler: FunctionHandler
    kwargs:
        function: "str"
        args: "xsrf"
        set_xsrf: true

# Display Gramex logs on console with indentation
log:
    version: 1
    root:
        level: DEBUG
        handlers:
            - error
    handlers:
        error:
            class: logging.StreamHandler
            level: INFO
            stream: ext://sys.stdout
            formatter: inline
    formatters:
        inline:
            format: '        %(message)s'

watch:
  watch_template:
    paths: watcher.txt
    on_modified: utils.on_modified
    on_created: utils.on_created
    on_deleted: utils.on_deleted

schedule:
  schedule-startup-set-key:
    function: utils.slow_count          # Set global value schedule-key to 1
    args: ['schedule-key', 1]
    startup: true
  schedule-startup-slow:
    function: utils.slow_count          # Set global schedule-count every 10ms
    args: 'schedule-count'
    kwargs: {count: 200}
    startup: true
    thread: true
