# Gramex APIs are versioned. The version key is required. Currently, 1.0 is the
# only version supported.
version: 1.0

# The `app:` section defines the settings for the Tornado application.
# http://tornado.readthedocs.org/en/stable/web.html#tornado.web.Application.settings
app:
    listen:
        port: 9988              # Port to bind to. (8888 used by Jupyter)
        xheaders: True
        max_buffer_size: 1000000000
        max_header_size: 1000000000
        max_body_size: 1000000000
    settings:                   # Tornado app settings
        # default_host: 'host'  # Optional name of default host
        autoreload: False
        debug: False
        compress_response: True
        serve_traceback: True
        cookie_secret: secret-key
        key_version:
        login_url: /login
        xsrf_cookies: True
        twitter_consumer_key: ...
        twitter_consumer_secret: ...
        friendfeed_consumer_key: ...
        friendfeed_consumer_secret: ...
        google_consumer_key: ...
        google_consumer_secret: ...
        facebook_api_key: ...
        facebook_secret: ...
        autoescape: True
        compiled_template_cache: True
        template_path: .
        static_hash_cache: True
        static_path: './static'
        static_url_prefix: '/static/'


# The `url:` section maps URL patterns to handlers.
# http://tornado.readthedocs.org/en/stable/web.html#tornado.web.URLSpec
url:
    reload-config:
        pattern: /reload-config
        handler: FunctionHandler            # Run function and redirect
        kwargs:
            function: gramex.init           # Run gramex.init()
            args: []                        # without any positional
            kwargs: {}                      # or keyword arguments
            redirect: /                     # Redirects to referer or / by default

    default:                            # A unique name for this handler
        priority: -1                    # Apply this pattern with low than normal priority
        pattern: /(.*)                  # All URLs beginning with /
        handler: FileHandler                        # Handler used
        kwargs:                                     # Options to the handler
            path: .                                 #   path is current dir
            default_filename: index.html            #   default filename
            index: true                             #   display the index

    lib:                                # The handler for component libraries
        pattern: /lib/(.*)              # Anything under /lib/
        handler: FileHandler
        kwargs:
            path: "{.}/lib"             # maps to /lib/ under the Gramex source folder
                                        # {.} is replaced with the conf file's folder
            index: true                 # Allow browsing the libraries

    # The `import:` key may be included anywhere. Its keys are just identifiers,
    # not used for anything. Its values are YAML files. They are loaded at the
    # end of the section, in order. After loading, the import: key is removed.

    # Imports work recursively. You can have imports within imports.

    # You can specify a relative or an absolute path. Gramex proceeds with a
    # warning if a file is missing. You can specify a `Path.glob` pattern as
    # well. (Note: absolute glob patterns are not implemented by `Path.glob`.)

    # import:
    #     app1: 'app1/gramex.url.yaml'        # relative path
    #     app2: 'd:/temp/gramex.url.yaml'     # absolute path
    #     subapps: '*/gramex.url.yaml'        # glob: 1st-level directory search
    #     deepapps: '**/gramex.url.yaml'      # glob: full subtree search


# The `log:` section defines the log handlers. It uses the same structure as the
# Python logging schema. By default, the system `gramex.yaml` has a log handler
# called `admin` that logs events for the admin page to display and filter.
#
# https://docs.python.org/2/library/logging.config.html#logging-config-dictschema
log:
    version: 1
    root:
        level: DEBUG
        handlers:
            - console
    handlers:
        console:
            class: logging.StreamHandler
            level: DEBUG
            stream: ext://sys.stdout
            formatter: console

        # Here are some sample log file formats
        # -------------------------------------------------------------------
        # Write all information logs into info.log, back up daily
        # info:
        #     class: logging.handlers.TimedRotatingFileHandler
        #     level: INFO
        #     formatter: file         # save it as a file
        #     filename: info.log      # file name to save as
        #     encoding: utf-8         # encoded as UTF-8
        #     when: D                 # rotate the log file day-wise
        #     interval: 1             # every single day
        #     utc: False              # using local time zone, not UTC
        #     backupCount: 30         # keep only last 30 backups

        # Write warnings into warn.log (up to 10 MB, then warn.log.1, etc)
        # warnings:
        #     class: logging.handlers.RotatingFileHandler
        #     level: WARN
        #     formatter: file
        #     filename: warn.log      #
        #     encoding: utf-8         # encoded as UTF-8
        #     maxBytes: 10485760      # limit the file to up to 10MB
        #     backupCount: 3          # keep the last 3 backups

    loggers:
        tornado.access: {}
        tornado.application: {}
        tornado.general: {}
    formatters:
        console:
            # TODO: use colorlog for console
            format: '%(levelname)1.1s %(asctime)s %(module)s:%(lineno)d %(message)s'
            datefmt: '%m-%b %H:%M:%S'
        file:
            format: '%(levelname)1.1s,%(asctime)s,%(module)s,%(lineno)d,"%(message)s"'
            datefmt: '%Y-%m-%d %H:%M:%S'


# The `schedule:` section defines when specific code is to run.
#
# https://github.com/josiahcarlson/parse-crontab
schedule:
    gramex-reconfig:
        function: gramex.init           # Reload Gramex config
        minutes: '*/30'                 # Every 30 minutes
    # scheduled-message:
    #     function: logging.info          # Run this function
    #     kwargs:                         # with these keys and values
    #         msg: This is a scheduled message
    #     years: '*'                      # Every year (* is default)
    #     months: 'jan, mar-may, 12'      # In Jan, Mar, Apr, May, Dec
    #     dates: '1, L'                   # On the first and last days
    #     weekdays: '*'                   # 0-6 or SUN-SAT
    #     hours: '*/3'                    # Every 3rd hour
    #     minutes: '*/5, 59'              # Every 5th minute, and 59th minute
    #     startup: true                   # In addition, run on startup


# Define custom MIME types here
mime:
    .yml:       text/yaml
    .yaml:      text/yaml
    .md:        text/markdown
    .markdown:  text/markdown
    .json:      application/json


# Watch here
watch: True

# The `error:` section defines error responses. When you raise
# `GramexError(key="...")`, Gramex calls the corresponding `function:` as
# `function(handler, status_code, **kwargs)` from RequestHandler.write_error()
# `kwargs['exc_info']` will have an `exc_info` triple.
#
# http://tornado.readthedocs.org/en/latest/web.html#tornado.web.RequestHandler.write_error

# error:
#     page-not-found:
#         code: 404
#         function: SimpleErrorPage
#         kwargs:
#           h1: Page not found
#           body: This is not the page you are looking for
#     custom-error:
#         code: 500
#         function: ErrorTemplateHandler
#         path: 500.html


# The `license:` section handles the following scenarios:
# - I only want to sell only the treemap application
# - I only want SAML Auth, not OAuth
# - I only want visual, not analytic components
# - Only single user license
#
# How are services, handlers and components identified?

# license:
#     default:                    # Name of license. (Multiple licenses possible)
#         key: ...                # License key for this license
#         systems:                # Systems this license is valid for
#             system-1:           # Name of the first system
#                 method:         #   Algorithm used to compute the sysid
#                 sysid:          #   System's unique ID based on algorithm
#             system-2:           # Name of the second system
#                 method:         #   Algorithm used to compute next sysid
#                 sysid:          #   ...
#         validity:               # From when to when is the license valid
#             start: 2015-01-01 00:00:00
#             end: 2016-01-01 00:00:00
#         users: 1                # Optional: max users allowed
#         inventory:              # What's allwoed. (Values matter; keys are just labels)
#             treemap:            # Each permission is a key
#                 services:       #   Allowed services
#                     ...         #     How to define these?
#                 handlers:       #   Allowed handlers
#                     ...         #     How to define these?


# email:

# cache:
#   - Output follows HTTP caching policy. Server acts as a caching HTTP proxy.
#   - Any structure can be cached and re-used across apps
#   - Any structure can be uniquely identified, possibly served as a URL
#   - Cache management: Delete LRU (least recently used), LFU (least frequently
#     used), etc. Based on memory / disk availability.
#   - Cache storage: memory, disk (serialization)
#   - Cache expiry, re-creation
#   - Cache must be thread-safe
#   - Cache record:
#     - Namespace
#     - Last updated
#     - Context (e.g. user)
#     - Hits (how often was this record retrieved)
#     - Data
#     - How to compute the data

# - **Rendering** components to PDF, PPTX, PNG, SVG, etc.
# - **Computation workflow**
# - **Queues**: If dataframes have to be stored, for example, and we want to
#   avoid too many dataframes being stored. Or if we need a cache with a limited
#   memory usage.
